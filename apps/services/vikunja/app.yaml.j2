---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vikunja-db-pvc
  labels:
    app: vikunja
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vikunja-files-pvc
  labels:
    app: vikunja
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: vikunja
spec:
  initContainers:
    - name: fix-perms
      image: busybox
      command: ["sh", "-c", "chown -R 1000:1000 /app/vikunja/files"]
      securityContext:
        runAsUser: 0
      volumeMounts:
        - name: vikunja-files
          mountPath: /app/vikunja/files
  containers:
    - image: docker.io/vikunja/vikunja:0.24.6
      name: vikunja
      env:
        - name: VIKUNJA_SERVICE_PUBLICURL
          value: https://vikunja.nospawnn.com
        - name: VIKUNJA_DATABASE_HOST
          value: db
        - name: VIKUNJA_DATABASE_PASSWORD
          value: "{{ vikunja_database_password }}"
        - name: VIKUNJA_DATABASE_TYPE
          value: postgres
        - name: VIKUNJA_DATABASE_USER
          value: vikunja
        - name: VIKUNJA_DATABASE_DATABASE
          value: vikunja
        - name: VIKUNJA_SERVICE_JWTSECRET
          value: "{{ vikunja_jwtsecret }}"
      ports:
        - containerPort: 3456
      volumeMounts:
        - mountPath: /app/vikunja/files
          name: vikunja-files
      securityContext:
        runAsUser: 1000
    - image: docker.io/postgres:18
      name: db
      env:
        - name: POSTGRES_PASSWORD
          value: "{{ vikunja_database_password }}"
        - name: POSTGRES_USER
          value: vikunja
      livenessProbe:
        exec:
          command:
            - /bin/sh
            - -c
            - pg_isready -h localhost -U $POSTGRES_USER
        initialDelaySeconds: 30
        periodSeconds: 2
        timeoutSeconds: 30
      volumeMounts:
        - mountPath: /var/lib/postgresql
          name: vikunja-db_data
  volumes:
    - name: vikunja-files
      persistentVolumeClaim:
        claimName: vikunja-files-pvc
    - name: vikunja-db_data
      persistentVolumeClaim:
        claimName: vikunja-db-pvc
