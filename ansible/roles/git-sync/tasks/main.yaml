- name: Ensure gitops dir is empty
  block:
    - name: Clear directory
      ansible.builtin.file:
        dest: "{{ gitops_dir }}"
        state: absent

    - name: Recreate directory
      ansible.builtin.file:
        dest: "{{ gitops_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0644"

- name: Pull git repo
  ansible.builtin.git:
    repo: "{{ gitops_repo }}"
    dest: "{{ gitops_dir }}"
    version: "{{ gitops_repo_rev }}"
    update: true

- name: Copy systemd unit
  ansible.builtin.template:
    src: git-sync.service.j2
    dest: /etc/systemd/system/git-sync.service
    owner: root
    group: root
    mode: "0644"

- name: Copy systemd timer
  ansible.builtin.template:
    src: git-sync@.timer.j2
    dest: /etc/systemd/system/git-sync@.timer
    owner: root
    group: root
    mode: "0644"

- name: Populate .vault_pass
  ansible.builtin.copy:
    dest: "{{ gitops_dir }}/.vault_pass"
    content: "{{ vault_password }}"
    mode: "0600"

- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true

- name: Initial sync
  ansible.builtin.systemd:
    name: git-sync.service
    state: started

- name: Enable sync timer
  ansible.builtin.systemd:
    name: git-sync@10.timer
    state: started
    enabled: true
